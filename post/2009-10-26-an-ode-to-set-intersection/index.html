<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https://fawx.com/"
        },
        "articleSection" : "post",
        "name" : "An Ode to Set Intersection",
        "headline" : "An Ode to Set Intersection",
        "description" : "<p>This here is Norman Casagrande, last.fm’s former head researcher and my former mentor.  The facial expression seen here is one of my favorites.  It’s usually accompanied by some questionably-translated Italian aphorism, ”You know, Erik, that is like the ox saying ‘horned’ to the donkey.”</p>

<p></p>",
        "inLanguage" : "pt-BR",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2009",
        "datePublished": "2009-10-26 15:07:14 -0700 PDT",
        "dateModified" : "2009-10-26 15:07:14 -0700 PDT",
        "url" : "https://fawx.com/post/2009-10-26-an-ode-to-set-intersection/",
        "wordCount" : "599",
        "image" : https://fawx.com/%!s(&lt;nil&gt;)",
        "keywords" : [ "Blog" ]   
    }
    </script>

 <title>An Ode to Set Intersection </title>


<meta name="description" content="Erik Frey&#39;s personal blog" />



<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" id="ct-tracks-google-fonts-css" href="//fonts.googleapis.com/css?family=Raleway%3A400%2C700&amp;subset=latin%2Clatin-ext&amp;ver=4.7.2" type="text/css" media="all">
<link rel="stylesheet" href="https://fawx.com/css/font-awesome.min.css" type='text/css' media='all'>

<link href="https://fawx.com/css/style.css" rel="stylesheet" id="theme-stylesheet" type='text/css' media='all'>

<link href="https://fawx.com/css/custom.css" rel="stylesheet" type='text/css' media='all'>
<link rel="shortcut icon" href="https://fawx.com/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="https://fawx.com/img/favicon.ico" type="image/x-icon">


</head>


<body class="post-template-default single single-post single-format-standard ct-body singular singular-post not-front standard">
  
  <div id="overflow-container" class="overflow-container">
    <a class="skip-content" href="#main">Skip to content</a>
    <header id="site-header" class="site-header" role="banner">
      <div class='top-navigation'>
        <div class='container'>

  <div id="menu-secondary" class="menu-container menu-secondary" role="navigation">
    <button id="toggle-secondary-navigation" class="toggle-secondary-navigation"><i class="fa fa-plus"></i></button>

    <div class="menu">

      <ul id="menu-secondary-items" class="menu-secondary-items">
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/categories/craft">craft</a>
        </li>
        
        <li id="menu-item" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item">
          <a href="/categories/life">life</a>
        </li>
        

      </ul>

    </div>

  </div>


  <ul class="social-media-icons">


    
    <li>
      <a href="https://www.facebook.com/therealerikfrey" data-animate-hover="pulse" class="facebook" target="_blank">
        <i class="fa fa-facebook-square" title="facebook"></i>
        <span class="screen-reader-text">facebook</span>
      </a>
    </li>
    

    

    

    

    
    <li>
      <a href="mailto:misc@fawx.com" data-animate-hover="pulse" class="email">
        <i class="fa fa-envelope" title="email"></i>
        <span class="screen-reader-text">email</span>
      </a>
    </li>
    

    
    <li>
      <a href="https://www.linkedin.com/in/therealerikfrey/" data-animate-hover="pulse" class="linkedin" target="_blank">
        <i class="fa fa-linkedin" title="linkedin"></i>
        <span class="screen-reader-text">linkedin</span>
      </a>
    </li>
    

    


    
    <li>
      <a href="https://github.com/erikfrey" data-animate-hover="pulse" class="github" target="_blank">
        <i class="fa fa-github" title="github"></i>
        <span class="screen-reader-text">github</span>
      </a>
    </li>
    


    

    
    <li>
      <a href="https://www.flickr.com/photos/erikfrey/" data-animate-hover="pulse" class="flickr" target="_blank">
        <i class="fa fa-flickr" title="flickr"></i>
        <span class="screen-reader-text">flickr</span>
      </a>
    </li>
    

    
    <li>
      <a href="https://fawx.com/index.xml" data-animate-hover="pulse" class="rss" target="_blank">
        <i class="fa fa-rss" title="rss"></i>
        <span class="screen-reader-text">rss</span>
      </a>
    </li>
    


  </ul></div>

      </div>

      <div class="container">
        <div id="title-info" class="title-info">
  <div id='site-title' class='site-title'>
    
    <a href="/"> fawx </a>
    </div>
  </div>
  <button id="toggle-navigation" class="toggle-navigation">
    <i class="fa fa-bars"></i>
  </button>

  <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
  <div id="menu-primary" class="menu-container menu-primary" role="navigation">
    
    <p class="site-description">some old and new ideas</p>
    

    <div class="menu">
      <ul id="menu-primary-items" class="menu-primary-items">
        
        
        <li id="menu-item" class='menu-item menu-item-type-custom menu-item-object-custom '>
          <a href="https://fawx.com/">Home</a>
          
        </li>
        
        <li id="menu-item" class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="https://fawx.com/about/">About</a>
          
        </li>
        
      </ul>
    </div>

  </div>

      </div>
    </header>

    <div id="main" class="main" role="main">

      
  <div id="loop-container" class="loop-container">
    

      <div class="post type-post status-publish format-standard hentry category-standard category-travel entry full-without-featured odd excerpt-1">

        
        <div class="entry-meta">
          <span class="date">October 2009</span>	<span> / </span>

          <span class="author">
            
            <a href="https://fawx.com/" title="Posts by Erik Frey" rel="author">Erik Frey</a>
            
          </span>


          
          <span class="category">
            <span> / </span>

            <a href="/categories/craft">craft</a>
          </span>
          


        </div>
        <div class='entry-header'>
          <h1 class='entry-title'> An Ode to Set Intersection</h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article>
              <p>This here is Norman Casagrande, last.fm’s former head researcher and my former mentor.  The facial expression seen here is one of my favorites.  It’s usually accompanied by some questionably-translated Italian aphorism, ”You know, Erik, that is like the ox saying ‘horned’ to the donkey.”</p>

<p></p>

<p>
<figure class="alignright">
    
        <img src="/img/2009/10/norman_casagrande.jpg" alt="Norman Casagrande" />
    
    
</figure>
 This smarmy smile also usually means I’m about to learn something new.  I saw it my very first day at last.fm.  Norman was describing to me various gears and nozzles that power last.fm’s recommendations, and when he showed me the code that compares two musical items, I stopped him.  I saw my chance to strike.</p>

<h2 id="set-intersection">Set Intersection</h2>

<p>Set intersection is a delightful little haiku problem in computer science.  It’s simple, elegant, and is ubiquitous in search engine tech, collaborative filtering mechanisms, various types of matrix math&hellip; probably other places, too!  Its most basic implementation is linear in complexity, and most people are happy with linear performance here.  But as I studied the guts of Norman’s recommendation engine, I saw my first opportunity to unleash unspeakable power!</p>

<p>“Norman, what if I told you that there are set intersections much more efficient than this?  In fact, I know of one that uses a search algorithm that is&hellip;”, I whispered almost breathlessly, “<em>log-log</em>!”</p>

<p>“Ehhh, you can try but I don’t think it will be faster.  But you throw the spaghetti at the ceiling propeller and we will see what stays there.”  And out came that infuriating smile.</p>

<p>So I set about to wipe that smile off Norman’s face.  I was going to write the Rolls-Royce jet engine of all set intersection algorithms.</p>

<h2 id="binary-and-interpolation-search">Binary and Interpolation Search</h2>

<p>To write my code I drew from the experience I’d had at a job interview with Google some time before.  A smart scientist had quizzed me about interpolation search, a way of finding elements in sorted sets by making educated guesses as to their location.  He claimed it had contributed greatly to the performance of operations at Google, so I was sure it could do the same for me.</p>

<p>In turn I’d found a really excellent paper on set intersection, <a href="https://pdfs.semanticscholar.org/4f5b/11f8b1962e70fec7266c2715bd7d22cfbf04.pdf">A Fast Set Intersection Algorithm for Sorted Sequences</a>.  This paper proposes the following algorithm:</p>

<ol>
<li>Pick the median element, A, in the smaller set.</li>
<li>Search for its insertion-position element, B, in the larger set.</li>
<li>If A and B are equal, append the element to the result.</li>
<li>Repeat steps 1-4 on non-empty subsets on either side of elements A and B.</li>
</ol>

<p>The paper showed that this algorithm does particularly well when one set is smaller than the other.  Just to be sure, I wrote code to count the number of comparisons for three kinds of set intersection: plain old linear set intersection, the paper&rsquo;s set intersection using double binary search, and my own variant using interpolation search.</p>

<p>View/download the source for this experiment from my <a href="https://github.com/erikfrey/themas">themas github repository</a>.  You can profile the algorithms on uniform random data by building the project and running:</p>

<pre><code>hexdump -e '1/4 &quot; %u&quot;' /dev/urandom | ./set_intersection_profile binary compares 100000 0.1 1.0 0.1 20
</code></pre>

<p>The results were exactly what I’d hoped, looking at the number of comparisons as I varied the ratio between the two set sizes:</p>


<figure class="size-auto">
    
        <img src="/img/2009/10/set_intersection_comparisons.jpg" alt="Set Intersection Comparisons" />
    
    
</figure>


<p>Not only did the interpolation intersection use far fewer comparisons in the case where <strong>M</strong> &lt;&lt; <strong>N</strong>, but it performed better than linear everywhere else, too!  Armed with this knowledge, I was ready to take Norman down.</p>

<p>To be continued!</p>

<p>p.s. For the observant programmer that is curious as to why the linear intersection’s line isn’t flat in the graph above, see <a href="https://github.com/erikfrey/themas/commit/e734e20712404bd403d7e103673d4b253df75247">this commit</a> and maybe read about <code>__builtin_expect</code>.  You’ll figure it out!</p>
            </article>
          </div>
          
      <div class='entry-meta-bottom'>
        

  
  <div class="entry-categories"><p><span>Categories</span>
    
    <a href="/categories/craft" title="View all posts in craft">craft</a>
  </p>
</div>
  


  

<div class="author-meta">

  <div class="author">
    <img alt='Erik Frey' src="https://www.gravatar.com/avatar/5bba3c7d293258d97c4f6036107c22a5?s=100&d=identicon" class='avatar avatar-72 photo' height='72' width='72'>

    <span>
      Written by:<a href="https://fawx.com/" title="Posts by Erik Frey" rel="author">Erik Frey</a>        </span>
    </div>
    <div class="bio">
      
      <p>Erik isn't quite sure who he is - his bio is in flux right now.</p>
      
      <p>Please try again later.</p>
      


      
      <a class="facebook" target="_blank"
      href="https://www.facebook.com/therealerikfrey">
      <i class="fa fa-facebook"
      title="facebook"></i>
    </a>
    

    


  

<a class="linkedin" target="_blank"
href="https://www.linkedin.com/in/therealerikfrey/">
<i class="fa fa-linkedin-square"
title="linkedin"></i>
</a>



<a class="email" target="_blank"
href="mailto:misc@fawx.com">
<i class="fa fa-envelope"
title="email"></i>
</a>







<a class="github" target="_blank"
href="https://github.com/erikfrey">
<i class="fa fa-github"
title="github"></i>
</a>






<a class="flickr" target="_blank"
href="https://www.flickr.com/photos/erikfrey/">
<i class="fa fa-flickr"
title="flickr"></i>
</a>




</div>
</div>

</div>
</div>

<section id="comments" class="comments">
  

  




</section>
</div>

 



    </div>

    <footer id="site-footer" class="site-footer" role="contentinfo">
	<h1>
    
    <a href=""> fawx </a>
    
	</h1>

			
			<p class="site-description">some old and new ideas</p>
			

		<div id="menu-footer" class="menu-container menu-footer" role="navigation">
		<div class="menu">

      <ul id="menu-footer-items" class="menu-footer-items">
        
</ul>

</div>	</div>

<ul class="social-media-icons">

        
				<li>
					<a class="facebook" target="_blank"
					   href="https://www.facebook.com/therealerikfrey" >
						<i class="fa fa-facebook" title="facebook"></i>
						<span class="screen-reader-text">facebook</span>
					</a>
				</li>
        

        


        

        

        
        <li>
        <a href="mailto:misc@fawx.com"  class="email">
            <i class="fa fa-envelope" title="email"></i>
            <span class="screen-reader-text">email</span>
        </a>
        </li>
        

        
        <li>
        <a href="https://www.linkedin.com/in/therealerikfrey/" class="linkedin" target="_blank">
            <i class="fa fa-linkedin" title="linkedin"></i>
            <span class="screen-reader-text">linkedin</span>
        </a>
        </li>
        

        


        
        <li>
        <a href="https://github.com/erikfrey"  class="github" target="_blank">
            <i class="fa fa-github" title="github"></i>
            <span class="screen-reader-text">github</span>
        </a>
        </li>
        


        

				
        <li>
        <a href="https://www.flickr.com/photos/erikfrey/"  class="flickr" target="_blank">
            <i class="fa fa-flickr" title="flickr"></i>
            <span class="screen-reader-text">flickr</span>
        </a>
        </li>
        

        
        <li>
        <a href="https://fawx.com/index.xml" data-animate-hover="pulse" class="rss" target="_blank">
            <i class="fa fa-rss" title="rss"></i>
            <span class="screen-reader-text">rss</span>
        </a>
        </li>
        

				</ul>	<div class="design-credit">
		
		<p>&copy; 2003 Erik Frey</p>
		
	</div>
</footer>

  </div>
  <script src="https://fawx.com/js/jquery.min.js"></script>
<script src="https://fawx.com/js/jquerymigrate.js"></script>
<script src="https://fawx.com/js/production.min.js"></script>

</body>
</html>
